name: üîç Quality - An√°lise de Qualidade

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Executa diariamente √†s 3h UTC (0h BRT)
    - cron: '0 3 * * *'
  workflow_dispatch:

concurrency:
  group: quality-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '18.x'

jobs:
  # üßπ Code Quality
  code-quality:
    name: üßπ An√°lise de C√≥digo
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Necess√°rio para an√°lise hist√≥rica
          
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: üì¶ Instalar depend√™ncias
        run: npm ci
        
      - name: üßπ ESLint com relat√≥rio
        run: |
          npm run lint -- --format json --output-file eslint-report.json || true
          npm run lint -- --format html --output-file eslint-report.html || true
          
      - name: üìä Prettier Check
        run: |
          npx prettier --check "src/**/*.{js,jsx,ts,tsx,json,css,md}" || true
          
      - name: üîç Verificar imports duplicados
        run: |
          echo "## üîç Verifica√ß√£o de Imports" >> $GITHUB_STEP_SUMMARY
          find src -name "*.jsx" -o -name "*.js" | xargs grep -h "^import" | sort | uniq -d | head -10 >> $GITHUB_STEP_SUMMARY || true
          
      - name: üìä An√°lise de complexidade
        run: |
          npx madge --circular src/ || echo "‚ùå Depend√™ncias circulares encontradas"
          npx madge --summary src/ >> $GITHUB_STEP_SUMMARY
          
      - name: üì§ Upload relat√≥rios
        uses: actions/upload-artifact@v3
        with:
          name: code-quality-reports
          path: |
            eslint-report.json
            eslint-report.html

  # üìä SonarCloud Analysis
  sonarcloud:
    name: üìä SonarCloud
    runs-on: ubuntu-latest
    if: github.actor != 'dependabot[bot]'
    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: üì¶ Instalar depend√™ncias
        run: npm ci
        
      - name: üß™ Executar testes com coverage
        run: npm run test:coverage
        
      - name: üìä SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=mestres-do-cafe
            -Dsonar.organization=sua-org
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
            -Dsonar.exclusions=**/node_modules/**,**/dist/**,**/*.test.js,**/*.spec.js

  # üîí Security Scan
  security:
    name: üîí An√°lise de Seguran√ßa
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4
        
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: üì¶ Instalar depend√™ncias
        run: npm ci
        
      - name: üîí npm audit
        run: |
          echo "## üîí Auditoria de Seguran√ßa" >> $GITHUB_STEP_SUMMARY
          npm audit --audit-level moderate --json > audit-frontend.json || true
          npm audit --audit-level moderate >> $GITHUB_STEP_SUMMARY || echo "‚ö†Ô∏è Vulnerabilidades encontradas"
          
      - name: üîí Backend audit
        run: |
          cd server
          npm audit --audit-level moderate --json > ../audit-backend.json || true
          npm audit --audit-level moderate >> $GITHUB_STEP_SUMMARY || echo "‚ö†Ô∏è Vulnerabilidades no backend"
          
      - name: üïµÔ∏è CodeQL Analysis
        uses: github/codeql-action/init@v2
        with:
          languages: javascript
          
      - name: üîç Autobuild
        uses: github/codeql-action/autobuild@v2
        
      - name: üîç Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2
        with:
          category: "/language:javascript"
          
      - name: üì§ Upload security reports
        uses: actions/upload-artifact@v3
        with:
          name: security-reports
          path: |
            audit-frontend.json
            audit-backend.json

  # üéØ Performance Analysis
  performance:
    name: üéØ An√°lise de Performance
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4
        
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: üì¶ Instalar depend√™ncias
        run: npm ci
        
      - name: üèóÔ∏è Build para an√°lise
        run: npm run build
        
      - name: üìä Bundle Analysis
        run: |
          echo "## üì¶ An√°lise do Bundle" >> $GITHUB_STEP_SUMMARY
          echo "| Arquivo | Tamanho | Gzip |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|------|" >> $GITHUB_STEP_SUMMARY
          
          cd dist
          for file in $(find . -name "*.js" -o -name "*.css" | head -10); do
            original=$(du -h "$file" | cut -f1)
            gzip -k "$file"
            compressed=$(du -h "$file.gz" | cut -f1)
            echo "| $file | $original | $compressed |" >> $GITHUB_STEP_SUMMARY
            rm "$file.gz"
          done
          
      - name: üîç Verificar imports n√£o utilizados
        run: |
          npx unimported || echo "‚ö†Ô∏è Imports n√£o utilizados encontrados"
          
      - name: üìä Analyze dependencies
        run: |
          echo "## üìä Depend√™ncias Principais" >> $GITHUB_STEP_SUMMARY
          npm list --depth=0 --json | jq -r '.dependencies | to_entries[] | "- \(.key): \(.value.version)"' | head -20 >> $GITHUB_STEP_SUMMARY

  # üìù Documentation Check
  documentation:
    name: üìù Verifica√ß√£o de Documenta√ß√£o
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4
        
      - name: üìù Verificar README
        run: |
          echo "## üìö Verifica√ß√£o de Documenta√ß√£o" >> $GITHUB_STEP_SUMMARY
          
          # Verificar se README existe e tem conte√∫do m√≠nimo
          if [ -f "README.md" ] && [ $(wc -l < README.md) -gt 50 ]; then
            echo "‚úÖ README.md: OK" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå README.md: Incompleto ou inexistente" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Verificar links quebrados no README
          if command -v markdown-link-check >/dev/null 2>&1; then
            npx markdown-link-check README.md >> $GITHUB_STEP_SUMMARY || true
          fi
          
      - name: üìä Verificar cobertura de testes
        run: |
          echo "## üß™ Cobertura de Testes" >> $GITHUB_STEP_SUMMARY
          
          # Contar arquivos de teste
          total_components=$(find src/components -name "*.jsx" | wc -l)
          test_components=$(find tests -name "*.test.jsx" | wc -l)
          
          echo "- Componentes: $total_components" >> $GITHUB_STEP_SUMMARY
          echo "- Testes: $test_components" >> $GITHUB_STEP_SUMMARY
          echo "- Cobertura: $(($test_components * 100 / $total_components))%" >> $GITHUB_STEP_SUMMARY

  # üè∑Ô∏è Dependency Review
  dependency-review:
    name: üè∑Ô∏è Revis√£o de Depend√™ncias
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4
        
      - name: üîç Dependency Review
        uses: actions/dependency-review-action@v3
        with:
          fail-on-severity: moderate
          allow-licenses: MIT, Apache-2.0, BSD-3-Clause, ISC
          
  # üìä Code Coverage
  coverage:
    name: üìä Cobertura de C√≥digo
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4
        
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: üì¶ Instalar depend√™ncias
        run: npm ci
        
      - name: üß™ Testes Frontend com Coverage
        run: npm run test:coverage
        
      - name: üß™ Testes Backend com Coverage
        run: |
          cd server
          npm ci
          npm run test:coverage
          
      - name: üìä Upload to Codecov
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info,./server/coverage/lcov.info
          flags: quality-check
          name: quality-coverage
          
      - name: üìä Coverage Summary
        run: |
          echo "## üìä Resumo da Cobertura" >> $GITHUB_STEP_SUMMARY
          if [ -f "coverage/coverage-summary.json" ]; then
            node -e "
              const coverage = require('./coverage/coverage-summary.json');
              console.log('| Tipo | Porcentagem |');
              console.log('|------|-------------|');
              console.log('| Linhas | ' + coverage.total.lines.pct + '% |');
              console.log('| Fun√ß√µes | ' + coverage.total.functions.pct + '% |');
              console.log('| Branches | ' + coverage.total.branches.pct + '% |');
              console.log('| Statements | ' + coverage.total.statements.pct + '% |');
            " >> $GITHUB_STEP_SUMMARY
          fi

  # üìã Quality Gate
  quality-gate:
    name: üìã Quality Gate
    runs-on: ubuntu-latest
    needs: [code-quality, security, performance, coverage]
    if: always()
    steps:
      - name: üìä Verificar Quality Gate
        run: |
          echo "## üéØ Quality Gate Results" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| üßπ Code Quality | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üîí Security | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üéØ Performance | ${{ needs.performance.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üìä Coverage | ${{ needs.coverage.result }} |" >> $GITHUB_STEP_SUMMARY
          
          # Verificar se todos os checks passaram
          if [[ "${{ needs.code-quality.result }}" == "success" && 
                "${{ needs.security.result }}" == "success" && 
                "${{ needs.performance.result }}" == "success" && 
                "${{ needs.coverage.result }}" == "success" ]]; then
            echo "üéâ Quality Gate: PASSED ‚úÖ" >> $GITHUB_STEP_SUMMARY
            echo "quality-gate-status=passed" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Quality Gate: FAILED ‚ùå" >> $GITHUB_STEP_SUMMARY
            echo "quality-gate-status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          
      - name: üì¢ Comment PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const status = '${{ steps.quality-gate.outputs.quality-gate-status }}';
            const emoji = status === 'passed' ? '‚úÖ' : '‚ùå';
            const message = status === 'passed' ? 'Quality Gate PASSED' : 'Quality Gate FAILED';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ${emoji} ${message}\n\nüîç Todos os checks de qualidade foram executados. Verifique os detalhes na aba Actions.`
            }); 