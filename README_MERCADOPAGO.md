# MercadoPago Checkout Transparente - Guia de Instala√ß√£o
=========================================================

Este documento fornece instru√ß√µes completas para configurar e usar a integra√ß√£o MercadoPago Checkout Transparente na aplica√ß√£o MestresdoCafe.

## üìã √çndice

- [Vis√£o Geral](#-vis√£o-geral)
- [Pr√©-requisitos](#-pr√©-requisitos)
- [Configura√ß√£o do Ambiente](#-configura√ß√£o-do-ambiente)
- [Instala√ß√£o](#-instala√ß√£o)
- [Configura√ß√£o das Credenciais](#-configura√ß√£o-das-credenciais)
- [Execu√ß√£o dos Testes](#-execu√ß√£o-dos-testes)
- [Estrutura do Projeto](#-estrutura-do-projeto)
- [Como Usar](#-como-usar)
- [Configura√ß√£o para Produ√ß√£o](#-configura√ß√£o-para-produ√ß√£o)
- [Troubleshooting](#-troubleshooting)
- [Suporte](#-suporte)

## üöÄ Vis√£o Geral

A integra√ß√£o MercadoPago Checkout Transparente oferece:

- **Pagamentos com Cart√£o**: Visa, Mastercard, Amex, Elo, Hipercard
- **PIX**: Pagamento instant√¢neo com QR Code
- **Boleto Banc√°rio**: Gera√ß√£o autom√°tica de boletos
- **Webhooks**: Notifica√ß√µes autom√°ticas de mudan√ßa de status
- **Tokeniza√ß√£o**: Seguran√ßa m√°xima para dados de cart√£o
- **3D Secure**: Autentica√ß√£o adicional para transa√ß√µes
- **Marketplace**: Suporte a split de pagamentos

## üì¶ Pr√©-requisitos

### Ambiente de Desenvolvimento

```bash
# Vers√µes m√≠nimas
Node.js >= 16.x
Python >= 3.9
PostgreSQL >= 12.x
```

### Conta MercadoPago

1. Conta no [MercadoPago Developers](https://www.mercadopago.com.br/developers)
2. Credenciais de teste configuradas
3. Webhook configurado (opcional para testes)

## ‚öôÔ∏è Configura√ß√£o do Ambiente

### 1. Clone e Configure o Projeto

```bash
# Clone o reposit√≥rio
git clone [URL_DO_REPOSITORIO]
cd mestres_cafe_enterprise

# Configure o ambiente Python (Backend)
cd apps/api
python -m venv venv
source venv/bin/activate  # Linux/Mac
# ou
venv\Scripts\activate  # Windows

# Instale depend√™ncias Python
pip install -r requirements.txt

# Configure o ambiente Node.js (Frontend)
cd ../web
npm install
```

### 2. Configura√ß√£o do Banco de Dados

```bash
# Execute as migra√ß√µes
cd apps/api
python -m alembic upgrade head

# Ou execute o setup inicial se necess√°rio
python src/database.py
```

## üîê Configura√ß√£o das Credenciais

### 1. Arquivo .env (Backend)

Crie o arquivo `apps/api/.env` baseado no `.env.example`:

```bash
# Copie o arquivo de exemplo
cd apps/api
cp .env.example .env
```

Configure as vari√°veis do MercadoPago:

```env
# Credenciais MercadoPago (TESTE)
MP_ACCESS_TOKEN_TEST=TEST-6470757372800949-072017-f45dc4b7ff499723f495a8525cfc9112-1211284486
MP_PUBLIC_KEY_TEST=TEST-6470757372800949-072017-f45dc4b7ff499723f495a8525cfc9112-1211284486
MP_ENVIRONMENT=sandbox

# Configura√ß√µes da Aplica√ß√£o MercadoPago
MP_APPLICATION_ID=1211284486
MP_APPLICATION_NUMBER=6470757372800949

# Configura√ß√µes Avan√ßadas
MP_ENABLE_3DS=true
MP_ENABLE_TOKENIZATION=true
MP_MARKETPLACE_FEE_PERCENTAGE=2.5
MP_WEBHOOK_SECRET=your_webhook_secret_here

# URLs
MP_WEBHOOK_URL=http://localhost:5000/api/payments/mercadopago/webhook
MP_SUCCESS_URL=http://localhost:3000/checkout/success
MP_FAILURE_URL=http://localhost:3000/checkout/failure
MP_PENDING_URL=http://localhost:3000/checkout/pending
```

### 2. Configura√ß√£o Frontend

O frontend detecta automaticamente o ambiente baseado na URL. Para desenvolvimento local, as credenciais de teste s√£o usadas automaticamente.

## üéØ Instala√ß√£o

### 1. Backend (API)

```bash
cd apps/api

# Ative o ambiente virtual
source venv/bin/activate

# Instale depend√™ncias espec√≠ficas do MercadoPago
pip install mercadopago==2.2.0

# Execute a aplica√ß√£o
python -m flask run --host=0.0.0.0 --port=5000
```

### 2. Frontend (Web)

```bash
cd apps/web

# Instale depend√™ncias (se n√£o fez antes)
npm install

# Execute em modo de desenvolvimento
npm run dev
```

### 3. Verifica√ß√£o da Instala√ß√£o

Acesse:
- Backend: http://localhost:5000/api/health
- Frontend: http://localhost:3000
- API MercadoPago: http://localhost:5000/api/payments/mercadopago/transparent/payment-methods

## üß™ Execu√ß√£o dos Testes

### 1. Testes Automatizados

```bash
# Execute o script de setup e testes
cd scripts
python setup_mercadopago_tests.py

# Ou execute apenas os testes
python setup_mercadopago_tests.py --test-only

# Ou execute apenas o setup
python setup_mercadopago_tests.py --setup-only
```

### 2. Testes Manuais

Consulte o arquivo [`docs/MERCADO_PAGO_GUIA_TESTES.md`](docs/MERCADO_PAGO_GUIA_TESTES.md) para instru√ß√µes detalhadas de testes manuais.

### 3. Cart√µes de Teste

| Bandeira | N√∫mero | CVV | Validade | Nome | Status |
|----------|--------|-----|----------|------|--------|
| Visa | 4235 6477 2802 5682 | 123 | 11/25 | APRO | Aprovado |
| Visa | 4509 9535 6623 3704 | 123 | 11/25 | OTHE | Rejeitado |
| Mastercard | 5031 4332 1540 6351 | 123 | 11/25 | APRO | Aprovado |
| Amex | 3753 651535 56885 | 1234 | 11/25 | APRO | Aprovado |

**CPF de Teste**: 191.191.191-00

## üìÅ Estrutura do Projeto

```
mestres_cafe_enterprise/
‚îú‚îÄ‚îÄ apps/
‚îÇ   ‚îú‚îÄ‚îÄ api/                          # Backend Flask
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ .env.example              # Configura√ß√µes de exemplo
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ mercado_pago_service.py    # Servi√ßo principal
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ controllers/routes/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ mercado_pago.py           # Endpoints da API
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ mercado_pago_validation.py # Valida√ß√µes
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ models/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ payments.py              # Modelos de pagamento
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ requirements.txt          # Depend√™ncias Python
‚îÇ   ‚îî‚îÄ‚îÄ web/                         # Frontend React
‚îÇ       ‚îú‚îÄ‚îÄ src/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ components/
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ MercadoPagoTransparentCheckout.jsx
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ hooks/
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ useMercadoPago.js        # Hook customizado
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ mercadopago.js          # Configura√ß√µes
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ examples/
‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ CheckoutIntegration.jsx  # Exemplo de integra√ß√£o
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îú‚îÄ‚îÄ MERCADO_PAGO_CHECKOUT_TRANSPARENTE.md  # Documenta√ß√£o t√©cnica
‚îÇ   ‚îî‚îÄ‚îÄ MERCADO_PAGO_GUIA_TESTES.md           # Guia de testes
‚îî‚îÄ‚îÄ scripts/
    ‚îî‚îÄ‚îÄ setup_mercadopago_tests.py           # Script de testes
```

## üéÆ Como Usar

### 1. Integra√ß√£o B√°sica

```jsx
import React from 'react';
import { useMercadoPago } from '../hooks/useMercadoPago';
import MercadoPagoTransparentCheckout from '../components/MercadoPagoTransparentCheckout';

function CheckoutPage() {
  const { isLoaded, processPayment } = useMercadoPago({
    onPaymentSuccess: (result) => {
      console.log('Pagamento aprovado:', result);
      // Redirecionar para p√°gina de sucesso
    },
    onPaymentError: (error) => {
      console.error('Erro no pagamento:', error);
      // Exibir mensagem de erro
    }
  });

  const handlePayment = async (paymentData) => {
    return await processPayment({
      ...paymentData,
      amount: 100.00,
      description: 'Compra no site'
    });
  };

  if (!isLoaded) {
    return <div>Carregando...</div>;
  }

  return (
    <MercadoPagoTransparentCheckout
      amount={100.00}
      orderId="order-123"
      onPaymentSubmit={handlePayment}
    />
  );
}
```

### 2. Processamento Backend

```python
from services.mercado_pago_service import MercadoPagoService

# Inicializar servi√ßo
mp_service = MercadoPagoService()

# Processar pagamento
payment_data = {
    'order_id': 'order-123',
    'payment_method_id': 'visa',
    'token': 'card_token_here',
    'amount': 100.00,
    'payer_email': 'user@example.com'
}

result = mp_service.process_transparent_payment(payment_data)
print(f"Status: {result['status']}")
```

## üöÄ Configura√ß√£o para Produ√ß√£o

### 1. Obtenha Credenciais de Produ√ß√£o

1. Acesse o [Painel do MercadoPago](https://www.mercadopago.com.br/developers/panel)
2. Complete o processo de verifica√ß√£o da conta
3. Obtenha as credenciais de produ√ß√£o

### 2. Atualize as Configura√ß√µes

```env
# Substitua as credenciais no .env
MP_ACCESS_TOKEN=PROD-your-production-access-token
MP_PUBLIC_KEY=PROD-your-production-public-key
MP_ENVIRONMENT=production

# Configure webhook de produ√ß√£o
MP_WEBHOOK_URL=https://yourdomain.com/api/payments/mercadopago/webhook
```

### 3. Configure Webhooks

1. Acesse **Suas Integra√ß√µes > Webhooks** no painel
2. Adicione: `https://yourdomain.com/api/payments/mercadopago/webhook`
3. Selecione eventos: `payment`, `merchant_order`

### 4. Teste em Produ√ß√£o

```bash
# Execute testes com credenciais de produ√ß√£o
python scripts/setup_mercadopago_tests.py --production
```

## üîß Troubleshooting

### Problemas Comuns

#### 1. Erro de Credenciais

```
‚ùå Credenciais de teste do MercadoPago n√£o configuradas
```

**Solu√ß√£o**: Verifique se as vari√°veis `MP_ACCESS_TOKEN_TEST` e `MP_PUBLIC_KEY_TEST` est√£o configuradas no `.env`

#### 2. SDK n√£o Carrega

```
‚ùå Falha ao carregar SDK do MercadoPago
```

**Solu√ß√£o**: 
- Verifique conex√£o com internet
- Desabilite bloqueadores de script
- Teste em modo inc√≥gnito

#### 3. Pagamento Rejeitado

```
‚ùå cc_rejected_bad_filled_card_number
```

**Solu√ß√£o**: Use cart√µes de teste v√°lidos (consulte tabela acima)

#### 4. Webhook n√£o Funciona

```
‚ùå Webhook signature validation failed
```

**Solu√ß√£o**: 
- Configure `MP_WEBHOOK_SECRET`
- Use ngrok para desenvolvimento local
- Verifique se a URL est√° acess√≠vel

### Logs e Debug

```bash
# Ativar logs detalhados
export FLASK_ENV=development
export FLASK_DEBUG=1

# Verificar logs
tail -f apps/api/logs/app.log | grep "mercado_pago"
```

### Verifica√ß√£o de Sa√∫de

```bash
# Status da API
curl http://localhost:5000/api/health

# M√©todos de pagamento
curl http://localhost:5000/api/payments/mercadopago/transparent/payment-methods

# Valida√ß√£o de dados
curl -X POST http://localhost:5000/api/payments/mercadopago/transparent/validate-payment \
  -H "Content-Type: application/json" \
  -d '{"payer_doc_number":"19119119100","payer_email":"test@test.com"}'
```

## üìû Suporte

### Documenta√ß√£o Adicional

- [Documenta√ß√£o T√©cnica Completa](docs/MERCADO_PAGO_CHECKOUT_TRANSPARENTE.md)
- [Guia de Testes Detalhado](docs/MERCADO_PAGO_GUIA_TESTES.md)
- [Exemplo de Integra√ß√£o](apps/web/src/examples/CheckoutIntegration.jsx)

### Links √öteis

- [Documenta√ß√£o MercadoPago](https://www.mercadopago.com.br/developers/pt/guides)
- [Status da API MercadoPago](https://status.mercadopago.com/)
- [Comunidade Developers](https://www.mercadopago.com.br/developers/pt/community)

### Contato

Para d√∫vidas espec√≠ficas da implementa√ß√£o:

- Consulte os arquivos de documenta√ß√£o na pasta `/docs`
- Execute o script de diagn√≥stico: `python scripts/setup_mercadopago_tests.py`
- Verifique os logs da aplica√ß√£o em `apps/api/logs/`

---

## üìã Checklist de Implementa√ß√£o

- [x] ‚öôÔ∏è Configura√ß√£o das credenciais de teste
- [x] üîß Implementa√ß√£o do servi√ßo MercadoPago
- [x] üì° Endpoints da API configurados  
- [x] üõ°Ô∏è Middleware de valida√ß√£o implementado
- [x] üé® Componente React funcional
- [x] üîó Hooks de integra√ß√£o criados
- [x] üìù Documenta√ß√£o completa
- [x] üß™ Scripts de teste automatizados
- [x] üåê Exemplo de integra√ß√£o funcional
- [ ] üöÄ Configura√ß√£o para produ√ß√£o
- [ ] ‚úÖ Testes em ambiente real
- [ ] üìä Monitoramento configurado

**Status**: ‚úÖ **Implementa√ß√£o Completa para Ambiente de Teste**

A integra√ß√£o MercadoPago Checkout Transparente est√° totalmente implementada e pronta para testes. Siga este guia para configurar o ambiente e executar valida√ß√µes antes de migrar para produ√ß√£o.