import { createContext, useContext, useEffect, useState } from 'react';
import { cartAPI } from "../lib/api.js";
import { useAuth } from './AuthContext';

// =============================================
// CART UTILITIES - FUN√á√ïES LOCAIS E SUPABASE
// =============================================

// ‚úÖ Fun√ß√£o auxiliar para validar UUIDs
const isValidUUID = (uuid) => {
  if (!uuid || typeof uuid !== 'string') return false;
  const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
  return uuidRegex.test(uuid);
};

const cartUtils = {
  // Fun√ß√µes para localStorage (fallback quando n√£o logado)
  updateCartCount() {
    const cartCount = this.getCartItemsCount();
    const cartBadges = document.querySelectorAll('.cart-count-badge');
    cartBadges.forEach(badge => {
      badge.textContent = cartCount;
      badge.style.display = cartCount > 0 ? 'inline-block' : 'none';
    });
  },

  getCartItemsCount() {
    const cart = localStorage.getItem('cart');
    if (!cart) return 0;
    
    try {
      const cartData = JSON.parse(cart);
      return cartData.items?.reduce((total, item) => total + item.quantity, 0) || 0;
    } catch {
      return 0;
    }
  },

  saveCart(cartData) {
    localStorage.setItem('cart', JSON.stringify(cartData));
    this.updateCartCount();
  },

  getCart() {
    const cart = localStorage.getItem('cart');
    if (!cart) return { items: [], total: 0 };
    
    try {
      return JSON.parse(cart);
    } catch {
      return { items: [], total: 0 };
    }
  },

  clearCart() {
    localStorage.removeItem('cart');
    this.updateCartCount();
  },

  // Fun√ß√µes para API Flask
  async syncLocalCartToAPI(userId, localCart) {
    try {
      if (!localCart.items || localCart.items.length === 0) return;

      // Limpar carrinho existente na API
      await cartAPI.clearCart();

      // Adicionar itens do localStorage √† API
      for (const item of localCart.items) {
        await cartAPI.addToCart(item.id, item.quantity);
      }

      // Limpar localStorage ap√≥s sync
      this.clearCart();
    } catch (error) {
      console.error('Erro ao sincronizar carrinho:', error);
    }
  },

  // Fun√ß√£o para localStorage - adicionar item
  addToCart(product, quantity = 1) {
    const currentCart = this.getCart();
    const existingItem = currentCart.items.find(item => item.id === product.id);

    let newCartData;
    if (existingItem) {
      newCartData = {
        ...currentCart,
        items: currentCart.items.map(item =>
          item.id === product.id
            ? { ...item, quantity: item.quantity + quantity }
            : item
        )
      };
    } else {
      newCartData = {
        ...currentCart,
        items: [
          ...currentCart.items,
          {
            id: product.id,
            name: product.name,
            price: product.price,
            image: product.images && product.images.length > 0 ? product.images[0] : null,
            quantity: quantity,
            weight: product.weight,
            category: product.category
          }
        ]
      };
    }

    this.saveCart(newCartData);
    return newCartData;
  },

  // Fun√ß√£o para localStorage - remover item
  removeFromCart(productId) {
    const currentCart = this.getCart();
    const newCartData = {
      ...currentCart,
      items: currentCart.items.filter(item => item.id !== productId)
    };

    this.saveCart(newCartData);
    return newCartData;
  },

  // Fun√ß√£o para localStorage - atualizar quantidade
  updateQuantity(productId, newQuantity) {
    const currentCart = this.getCart();
    const newCartData = {
      ...currentCart,
      items: currentCart.items.map(item =>
        item.id === productId
          ? { ...item, quantity: newQuantity }
          : item
      )
    };

    this.saveCart(newCartData);
    return newCartData;
  }
};

// =============================================
// CART CONTEXT
// =============================================

const CartContext = createContext();

export const useCart = () => {
  const context = useContext(CartContext);
  if (!context) {
    throw new Error('useCart deve ser usado dentro de um CartProvider');
  }
  return context;
};

export const CartProvider = ({ children }) => {
  const { user } = useAuth();
  const [cartItems, setCartItems] = useState([]);
  const [cartTotal, setCartTotal] = useState(0);
  const [isLoading, setIsLoading] = useState(false);
  const [requiresLogin, setRequiresLogin] = useState(false);

  // Inicializa√ß√£o segura: carrinho APENAS para usu√°rios logados
  useEffect(() => {
    let isMounted = true;
    
    if (user && user.id && isMounted) {
      setRequiresLogin(false);
      loadCart();
    } else if (isMounted) {
      setRequiresLogin(true);
      setCartItems([]);
      setCartTotal(0);
    }
    
    return () => {
      isMounted = false;
    };
  }, [user]);

  // Calcular total do carrinho sempre que os itens mudarem
  useEffect(() => {
    let isMounted = true;
    
    if (isMounted) {
      const total = cartItems.reduce((sum, item) => {
        const price = parseFloat(item.price) || 0;
        const quantity = parseInt(item.quantity) || 0;
        return sum + (price * quantity);
      }, 0);
      setCartTotal(total);
    }
    
    return () => {
      isMounted = false;
    };
  }, [cartItems]);

  const loadCart = async () => {
    // üîí SEGURAN√áA: Carrinho APENAS para usu√°rios autenticados
    if (!user || !user.id) {
      setCartItems([]);
      setCartTotal(0);
      setRequiresLogin(true);
      return;
    }

    setIsLoading(true);
    setRequiresLogin(false);
    
    try {
      // üîí BUSCAR carrinho do usu√°rio logado via API Flask
      const response = await cartAPI.getCart();
      
      if (!response.success) {
        console.error('‚ùå Erro ao carregar carrinho:', response.message);
        setCartItems([]);
        return;
      }

      const cartItems = response.data.items || [];
      
      if (cartItems.length === 0) {
        setCartItems([]);
        return;
      }

      setCartItems(cartItems);
      } catch (error) {
      console.error('‚ùå Erro ao carregar carrinho:', error);
      setCartItems([]);
    } finally {
      setIsLoading(false);
    }
  };

  const addToCart = async (product, quantity = 1) => {
    // üîí SEGURAN√áA: Verifica√ß√µes rigorosas antes de qualquer opera√ß√£o
    if (!user || !user.id) {
      setRequiresLogin(true);
      return { success: false, message: 'Login necess√°rio para adicionar produtos ao carrinho' };
    }

    // ‚úÖ VALIDA√á√ÉO RIGOROSA: Verificar se temos produto v√°lido
    if (!product || !product.id) {
      console.error('‚ùå Produto inv√°lido ou sem ID:', product);
      return { success: false, message: 'Produto inv√°lido' };
    }

    try {
      console.log('üõí Adicionando ao carrinho (usu√°rio:', user.id, '- produto:', product.name, '- ID:', product.id, ')');
      
      // Adicionar via API Flask
      const response = await cartAPI.add(product.id, quantity);
      
      if (!response.success) {
        console.error('‚ùå Erro ao adicionar ao carrinho:', response.message);
        return { success: false, message: response.message || 'Erro ao adicionar produto' };
      }

      // Recarregar carrinho
      await loadCart();
      return { success: true, message: 'Produto adicionado ao carrinho!' };
      
    } catch (error) {
      console.error('‚ùå Erro ao adicionar ao carrinho:', error);
      return { success: false, message: 'Erro interno' };
    }
  };

  const removeFromCart = async (productId) => {
    // üîí SEGURAN√áA: Verifica√ß√µes rigorosas antes de qualquer opera√ß√£o
    if (!user || !user.id) {
      return { success: false, message: 'Login necess√°rio' };
    }

    // ‚úÖ VALIDA√á√ÉO RIGOROSA: Verificar se temos produto v√°lido
    if (!productId) {
      console.error('‚ùå Product ID n√£o fornecido');
      return { success: false, message: 'ID de produto n√£o fornecido' };
    }

    try {
      console.log('üóëÔ∏è Removendo do carrinho (usu√°rio:', user.id, '- produto:', productId, ')');
      
      // Remover via API Flask
      const response = await cartAPI.remove(productId);
      
      if (!response.success) {
        console.error('‚ùå Erro ao remover do carrinho:', response.message);
        return { success: false, message: response.message || 'Erro ao remover produto' };
      }

      // Recarregar carrinho
      await loadCart();
      return { success: true, message: 'Produto removido do carrinho!' };
      
    } catch (error) {
      console.error('‚ùå Erro ao remover do carrinho:', error);
      return { success: false, message: 'Erro interno' };
    }
  };

  const updateQuantity = async (productId, newQuantity) => {
    // üîí SEGURAN√áA: Verifica√ß√µes rigorosas antes de qualquer opera√ß√£o
    if (!user || !user.id) {
      return { success: false, message: 'Login necess√°rio' };
    }

    // ‚úÖ VALIDA√á√ÉO RIGOROSA: Verificar se temos produto v√°lido
    if (!productId) {
      console.error('‚ùå Product ID n√£o fornecido');
      return { success: false, message: 'ID de produto n√£o fornecido' };
    }

    try {
      if (newQuantity <= 0) {
        return await removeFromCart(productId);
      }

      console.log('üìù Atualizando quantidade (usu√°rio:', user.id, '- produto:', productId, '- qtd:', newQuantity, ')');
      
      // Atualizar via API Flask
      const response = await cartAPI.update(productId, newQuantity);
      
      if (!response.success) {
        console.error('‚ùå Erro ao atualizar quantidade:', response.message);
        return { success: false, message: response.message || 'Erro ao atualizar quantidade' };
      }

      // Recarregar carrinho
      await loadCart();
      return { success: true };
      
    } catch (error) {
      console.error('‚ùå Erro ao atualizar quantidade:', error);
      return { success: false, message: 'Erro interno' };
    }
  };

  const clearCart = async () => {
    // üîí SEGURAN√áA: Apenas usu√°rios autenticados podem limpar carrinho
    if (!user || !user.id) {
      return { success: false, message: 'Login necess√°rio' };
    }

    try {
      console.log('üßπ Limpando carrinho (usu√°rio:', user.id, ')');
      
      // Limpar via API Flask
      const response = await cartAPI.clear();
      
      if (!response.success) {
        console.error('‚ùå Erro ao limpar carrinho:', response.message);
        return { success: false, message: response.message || 'Erro ao limpar carrinho' };
      }
      
      setCartItems([]);
      setCartTotal(0);
      return { success: true, message: 'Carrinho limpo!' };
      
    } catch (error) {
      console.error('‚ùå Erro ao limpar carrinho:', error);
      return { success: false, message: 'Erro interno' };
    }
  };

  const getCartItemsCount = () => {
    if (!user || !user.id) return 0; // üîí Sem usu√°rio = sem carrinho
    return cartItems.reduce((total, item) => total + item.quantity, 0);
  };

  const getCartItemsCountSafe = () => {
    // üîí Vers√£o segura que sempre retorna 0 se n√£o logado
    if (!user || !user.id) return 0;
    
    try {
      return cartItems.reduce((total, item) => total + item.quantity, 0);
    } catch (error) {
      console.error('Erro em getCartItemsCountSafe:', error);
      return 0;
    }
  };

  const getTotalPrice = () => {
    if (!user || !user.id) return 0; // üîí Sem usu√°rio = sem total
    return cartTotal;
  };

  const value = {
    cartItems,
    cartTotal,
    isLoading,
    requiresLogin, // üîí Nova propriedade para indicar se login √© necess√°rio
    addToCart,
    removeFromCart,
    updateQuantity,
    clearCart,
    getCartItemsCount,
    getCartItemsCountSafe,
    getTotalPrice,
    loadCart
  };

  return (
    <CartContext.Provider value={value}>
      {children}
    </CartContext.Provider>
  );
};

export default CartProvider;

