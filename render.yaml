# render.yaml - Configuração de Deploy do Mestres do Café no Render
# Este arquivo define todos os serviços necessários para rodar a aplicação

services:
  # ========================================
  # Backend API - Flask
  # ========================================
  - type: web
    name: mestres-cafe-api
    runtime: python
    plan: starter # ou free para começar
    region: oregon # ou sao-paulo se disponível
    buildCommand: cd apps/api && chmod +x build.sh && ./build.sh
    startCommand: cd apps/api && chmod +x start.sh && ./start.sh
    rootDir: .
    envVars:
      - key: FLASK_ENV
        value: production
      - key: FLASK_DEBUG
        value: "0"
      - key: PYTHONPATH
        value: /opt/render/project/src/apps/api/src
      - key: PORT
        value: 5001
      # Neon Database (recomendado - melhor performance)
      - key: NEON_DATABASE_URL
        sync: false  # Adicionar manualmente no dashboard
      # Fallback: Render Database
      - key: DATABASE_URL
        fromDatabase:
          name: mestres-cafe-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: mestres-cafe-redis
          property: connectionString
      - key: SECRET_KEY
        generateValue: true
      - key: JWT_SECRET_KEY
        generateValue: true
      - key: CORS_ORIGINS
        value: https://mestres-cafe-web.onrender.com
      # Configurações de banco de dados
      - key: DB_POOL_SIZE
        value: "10"
      - key: DB_POOL_TIMEOUT
        value: "30"
      - key: DB_POOL_RECYCLE
        value: "300"
      # APIs externas - adicionar via dashboard do Render
      - key: MERCADO_PAGO_ACCESS_TOKEN
        sync: false
      - key: MELHOR_ENVIO_API_KEY
        sync: false
    autoDeploy: true
    healthCheckPath: /api/health
    
  # ========================================
  # Frontend Web - React/Vite
  # ========================================
  - type: web
    name: mestres-cafe-web
    runtime: static
    plan: starter # ou free para começar
    region: oregon # ou sao-paulo se disponível
    buildCommand: cd apps/web && npm install && npm run build:production
    rootDir: apps/web
    envVars:
      - key: NODE_ENV
        value: production
      - key: VITE_API_URL
        value: https://mestres-cafe-api.onrender.com
      - key: VITE_MERCADO_PAGO_PUBLIC_KEY
        sync: false
    pullRequestPreviewsEnabled: true
    autoDeploy: true

# ========================================
# Banco de Dados PostgreSQL
# ========================================
databases:
  - name: mestres-cafe-db
    plan: starter # ou free para começar
    region: oregon # ou sao-paulo se disponível
    databaseName: mestres_cafe
    user: mestres_cafe_user
    ipAllowList: [] # Permite conexões apenas dos serviços Render
    postgresMajorVersion: "15"

# ========================================
# Redis para Cache e Sessões
# ========================================
# Nota: Redis precisa ser criado manualmente no Render Dashboard
# pois não é suportado no render.yaml ainda

# ========================================
# Background Workers (opcional)
# ========================================
# - type: worker
#   name: mestres-cafe-worker
#   runtime: python
#   plan: starter
#   region: oregon
#   buildCommand: cd apps/api && pip install -r requirements.txt
#   startCommand: cd apps/api && python src/workers/queue_worker.py
#   rootDir: .
#   envVars:
#     - key: DATABASE_URL
#       fromDatabase:
#         name: mestres-cafe-db
#         property: connectionString
#     - key: REDIS_URL
#       fromService:
#         type: redis
#         name: mestres-cafe-redis
#         property: connectionString

# ========================================
# Cron Jobs (opcional)
# ========================================
# - type: cron
#   name: mestres-cafe-daily-reports
#   runtime: python
#   schedule: "0 0 * * *" # Meia-noite todo dia
#   buildCommand: cd apps/api && pip install -r requirements.txt
#   startCommand: cd apps/api && python src/jobs/daily_reports.py
#   rootDir: .
#   envVars:
#     - key: DATABASE_URL
#       fromDatabase:
#         name: mestres-cafe-db
#         property: connectionString