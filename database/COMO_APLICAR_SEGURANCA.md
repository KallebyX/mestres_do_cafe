# 🔒 GUIA DE APLICAÇÃO DE SEGURANÇA SUPABASE\n## Sistema Mestres do Café - Correções Database Linter\n\n---\n\n## **🎯 OBJETIVO**\nResolver **TODOS** os warnings de segurança detectados pelo Supabase Database Linter.\n\n---\n\n## **📋 PASSO A PASSO**\n\n### **1. 🔧 EXECUTAR SCRIPT NO SUPABASE**\n\n**1.1 Abra o Supabase Dashboard:**\n- Vá para: `https://supabase.com/dashboard/project/[SEU-PROJECT-ID]`\n- Clique em **\"SQL Editor\"** no menu lateral\n\n**1.2 Execute o script:**\n```sql\n-- Cole todo o conteúdo do arquivo database/security-fixes-complete.sql\n-- E execute (Ctrl+Enter ou botão Run)\n```\n\n**1.3 Verificar execução:**\n- ✅ Deve executar sem erros\n- ✅ Verificar as queries de verificação no final do script\n\n### **2. ⚙️ CONFIGURAÇÕES NO DASHBOARD**\n\n**2.1 Reduzir OTP Expiry:**\n- Vá para: **Authentication** > **Settings**\n- Encontre: **\"Email OTP Expiry\"**\n- Altere de: `3600` (1 hora) para: `600` (10 minutos)\n- **Save**\n\n**2.2 Habilitar Password Protection:**\n- Na mesma página: **Authentication** > **Settings**\n- Encontre: **\"Password Protection\"**\n- Habilite: **\"Check for leaked passwords\"**\n- **Save**\n\n**2.3 Verificar outras configurações:**\n- **Password Strength**: Mínimo 8 caracteres\n- **Session Timeout**: Configurar conforme necessário\n- **JWT Expiry**: Configurar conforme necessário\n\n### **3. 🧪 TESTAR CORREÇÕES**\n\n**3.1 Verificar RLS:**\n```sql\n-- Execute no SQL Editor para verificar\nSELECT \n    schemaname,\n    tablename,\n    rowsecurity as rls_enabled\nFROM pg_tables \nWHERE schemaname = 'public' \nAND tablename IN (\n    'product_reviews', \n    'blog_categories', \n    'discount_coupons',\n    'customer_segments',\n    'customer_segment_assignments', \n    'campaign_metrics',\n    'gamification_levels'\n);\n```\n\n**3.2 Verificar Policies:**\n```sql\n-- Contar policies por tabela\nSELECT \n    schemaname,\n    tablename,\n    COUNT(*) as policy_count\nFROM pg_policies \nWHERE schemaname = 'public'\nGROUP BY schemaname, tablename\nORDER BY tablename;\n```\n\n**3.3 Executar Database Linter novamente:**\n- Vá para: **Database** > **Database Linter**\n- Clique em **\"Run Linter\"**\n- Verificar se warnings diminuíram significativamente\n\n---\n\n## **✅ RESULTADO ESPERADO**\n\n### **Antes das Correções:**\n- 🔴 **7 erros** (RLS disabled)\n- 🟡 **17 warnings** (search_path + auth configs)\n- 🔵 **3 infos** (RLS sem policies)\n\n### **Depois das Correções:**\n- ✅ **0 erros** RLS\n- ✅ **0 warnings** search_path\n- ✅ **0 infos** policies\n- ⚠️ **2 warnings** auth configs (se não configurar no dashboard)\n\n---\n\n## **🚨 TROUBLESHOOTING**\n\n### **Erro: \"relation does not exist\"**\n**Causa**: Tabela mencionada no script não existe no seu banco\n**Solução**: Comentar/remover as linhas referentes à tabela inexistente\n\n### **Erro: \"policy already exists\"**\n**Causa**: Policy já foi criada anteriormente\n**Solução**: Script pode ser executado novamente, apenas ignore o erro\n\n### **Erro: \"permission denied\"**\n**Causa**: Usuário não tem permissões para alterar RLS\n**Solução**: Executar como superuser ou service_role\n\n### **Funções não encontradas**\n**Causa**: Função mencionada não existe no seu banco\n**Solução**: Comentar/remover as funções que não existem\n\n---\n\n## **📊 VERIFICAÇÃO FINAL**\n\n### **1. Database Linter**\n- Deve mostrar **significativamente menos warnings**\n- Erros críticos de RLS devem estar **zerados**\n\n### **2. Funcionalidade do Sistema**\n- ✅ Frontend deve continuar funcionando normalmente\n- ✅ Autenticação deve funcionar\n- ✅ Operações CRUD devem funcionar\n\n### **3. Logs de Segurança**\n- Verificar se não há erros de RLS nos logs\n- Confirmar que policies estão sendo aplicadas\n\n---\n\n## **🎯 PRÓXIMOS PASSOS**\n\n1. **Execute o script** `database/security-fixes-complete.sql`\n2. **Configure** as opções de auth no dashboard\n3. **Teste** o sistema para garantir que tudo funciona\n4. **Execute** o Database Linter novamente\n5. **Documente** quaisquer warnings restantes\n\n---\n\n## **💡 IMPORTANTE**\n\n- ⚠️ **Faça backup** antes de executar em produção\n- ✅ **Teste primeiro** em ambiente de desenvolvimento\n- 🔒 **Revise** as policies se tiver regras específicas de negócio\n- 📝 **Documente** as alterações para a equipe\n\n**Após aplicar estas correções, seu sistema terá segurança enterprise-grade!** 🚀" 